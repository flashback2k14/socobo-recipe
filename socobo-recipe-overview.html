<link href="elements.html" rel="import">
<script src="RecipeDao.js"></script>
<script src="ImageService.js"></script>
<dom-module id="socobo-recipe-overview">
  <style>
    :host{
    }

    #recipe_list{
      z-index: 19;
      margin-top: 20px;
    }

    #recipe_list:first-child{
      border-top: 2px solid #F4F0EC;
    }

    #no_recipes{
      font-size: 40px;
      text-align: center;
      font-family: sans-serif;
      font-weight: 100;
      color: #F4F0EC;
      line-height: 80px;
    }

    paper-fab{
      position: absolute;
      bottom: 40px;
      right: 40px;
    }

    paper-fab#add{
      display: block;
      --paper-fab-background: var(--default-primary-color);
      --paper-fab-keyboard-focus-background: var(--default-primary-color);
    }

    paper-fab#clear{
      display: none;
      --paper-fab-background: var(--accent-color);
      --paper-fab-keyboard-focus-background: var(--accent-color);
    }

  </style>
  <template>
      <div id="recipe_list">
        <template is="dom-if" if="{{!recipes.length}}">
          <p id="no_recipes">no recipes<br>available</p>
        </template>
        <template id="listItems" is="dom-repeat" items="{{recipes}}">
          <socobo-element-list-item
            class="singleItem"
            obj="{{item}}"
            isChecked="{{valueOfCheckBox}}"
            on-check="handleCheck"
            on-uncheck="handleUncheck"
            on-show_request="clicked"
            on-delete_request="removeRecipe"
            on-edit_request="edit"
            >
          </socobo-element-list-item>
        </template>
      </div>
      <paper-fab id="add" icon="add" on-click="addRecipe">
      </paper-fab>
      <paper-fab id="clear" icon="clear" on-click="removeAllChecked">
      </paper-fab>
      <socobo-recipe-details-show
        id="showDialog">
      </socobo-recipe-details-show>
      <socobo-recipe-details-add
        id="addDialog"
        on-add_request="addNewRecipe"
        ></socobo-recipe-details-add>
      <socobo-recipe-details-edit
        id="editDialog"
        on-edit_request="editRecipe">
      </socobo-recipe-details-edit>
      <paper-toast id="errorNotification" ></paper-toast>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'socobo-recipe-overview',
    properties: {
      recipes : {
        type : Array,
        value : []
      },
      user : {
        type : String,
        value : ""
      },
      url : {
        type : String,
        value : ""
      },
      expire : {
        type : Number,
        value : 0
      },
      checkedBoxes : {
        type : Object,
        value :  {
          number: 0,
          refs: []
        }
      },
      valueOfCheckBox : {
        type : Boolean,
        value : false
      }
    },
    handleCheck : function(e){
      this.checkedBoxes.number++;
      this.checkedBoxes.refs.push(e.detail);
      this.trackCheckedBoxes();
    },
    handleUncheck : function(e){
      this.checkedBoxes.number--;
      this.updateAfterDeletion(e.detail, this.checkedBoxes.refs, "checkedBoxes.refs");
      this.trackCheckedBoxes();
    },
    trackCheckedBoxes : function () {
      if(this.checkedBoxes.number > 0){
        this.switchButton(this.$.clear,this.$.add);
      }else{
        this.switchButton(this.$.add, this.$.clear);
      }
    },
    clicked : function (e){
      var image = new RecipeDao(this, this.user).findImage(e.detail);
      var recipe = e.detail;
      if(image !== undefined && image !== null && image !== ""){
        recipe.image = image;
      }
      this.$.showDialog.recipe = recipe;
      this.$.showDialog.state = "show";

      this.$.showDialog.toggleDialog();
    },
    edit : function (e){
      var image = new RecipeDao(this, this.user).findImage(e.detail);
      var recipe = e.detail;
      if(image !== undefined && image !== null && image !== ""){
        recipe.image = image;
      }
      this.$.editDialog.recipe = recipe;
      this.$.editDialog.initSteps();
      this.$.editDialog.initIngredients();
      this.$.editDialog.toggleDialog();
    },
    addRecipe : function(){
      this.$.addDialog.state = "add";
      this.$.addDialog.toggleDialog();
    },
    buttonAni : function (){
      this.playAnimation('entry');
    },
    getRecipes: function(){
      new RecipeDao(this, this.user).getAndUpdate();
    },
    removeRecipe : function (e){
      new RecipeDao(this, this.user).remove(e.detail);
      this.updateAfterDeletion(e.detail, this.recipes, 'recipes');
    },
    addNewRecipe : function(e){
      console.log(e.detail);
      new RecipeDao(this, this.user).add(e.detail);
      var counter = 0;
    },
    editRecipe : function(e){
      new RecipeDao(this, this.user).update(e.detail);
      new RecipeDao(this, this.user).getAll();
    },
    updateAfterDeletion : function(el, arr, pathToProperty){
      for(var i = 0; i < arr.length; i++){
        if(arr[i].ref == el.ref){
          this.splice(pathToProperty, i, 1);
        }
      }
    },
    removeAllChecked : function (e) {
      for(var i in this.checkedBoxes.refs){
        new RecipeDao(this, this.user).remove((this.checkedBoxes.refs)[i]);
        this.updateAfterDeletion(((this.checkedBoxes.refs)[i]), this.recipes, 'recipes');
        this.checkedBoxes.number--;
        this.updateAfterDeletion(e.detail, this.checkedBoxes.refs, "checkedBoxes.refs");
        this.trackCheckedBoxes();
      }
    },
    switchButton : function (enableButton, disableButton){
      disableButton.style.display = "none";
      enableButton.style.display = "block";
    }
  });
})();
</script>
